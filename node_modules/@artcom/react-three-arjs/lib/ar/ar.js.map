{"version":3,"file":"ar.js","names":["ARContext","createContext","videoDomElemSelector","AR","React","memo","tracking","children","sourceType","patternRatio","matrixCodeType","detectionMode","cameraParametersUrl","onCameraStreamReady","onCameraStreamError","useThree","gl","camera","arContext","useMemo","arToolkitSource","ArToolkitSource","arToolkitContext","ArToolkitContext","onResize","useCallback","onResizeElement","copyElementSizeTo","domElement","arController","canvas","projectionMatrix","copy","getProjectionMatrix","onUnmount","window","removeEventListener","dispose","cameraParam","video","document","querySelector","srcObject","getTracks","map","track","stop","remove","useEffect","init","style","position","pointerEvents","onloadedmetadata","console","log","videoWidth","videoHeight","orientation","options","addEventListener","useFrame","ready","update","value","useAR","arValue","useContext"],"sources":["../../src/ar/ar.js"],"sourcesContent":["import { useFrame, useThree } from \"@react-three/fiber\"\nimport { ArToolkitContext, ArToolkitSource } from \"@ar-js-org/ar.js/three.js/build/ar-threex\"\nimport React, { createContext, useCallback, useEffect, useMemo } from \"react\"\n\nconst ARContext = createContext({})\nconst videoDomElemSelector = \"#arjs-video\"\n\nconst AR = React.memo(function AR({\n  tracking = true,\n  children,\n  sourceType,\n  patternRatio,\n  matrixCodeType,\n  detectionMode,\n  cameraParametersUrl,\n  onCameraStreamReady,\n  onCameraStreamError,\n}) {\n  const { gl, camera } = useThree()\n\n  const arContext = useMemo(() => {\n    const arToolkitSource = new ArToolkitSource({ sourceType })\n    const arToolkitContext = new ArToolkitContext({\n      cameraParametersUrl,\n      detectionMode,\n      patternRatio,\n      matrixCodeType,\n    })\n\n    return { arToolkitContext, arToolkitSource }\n  }, [patternRatio, matrixCodeType, cameraParametersUrl, detectionMode, sourceType])\n\n  const onResize = useCallback(() => {\n    const { arToolkitContext, arToolkitSource } = arContext\n\n    arToolkitSource.onResizeElement()\n    arToolkitSource.copyElementSizeTo(gl.domElement)\n    if (arToolkitContext.arController !== null) {\n      arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)\n      camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix())\n    }\n  }, [gl, arContext, camera])\n\n  const onUnmount = useCallback(() => {\n    window.removeEventListener(\"resize\", onResize)\n\n    arContext.arToolkitContext.arController.dispose()\n    if (arContext.arToolkitContext.arController.cameraParam) {\n      arContext.arToolkitContext.arController.cameraParam.dispose()\n    }\n\n    delete arContext.arToolkitContext\n    delete arContext.arToolkitSource\n\n    const video = document.querySelector(videoDomElemSelector)\n    if (video) {\n      video.srcObject.getTracks().map(track => track.stop())\n      video.remove()\n    }\n  }, [onResize, arContext])\n\n  useEffect(() => {\n    arContext.arToolkitSource.init(() => {\n      const video = document.querySelector(videoDomElemSelector)\n      video.style.position = \"fixed\"\n      video.style.pointerEvents = \"none\"\n\n      video.onloadedmetadata = () => {\n        console.log(\"actual source dimensions\", video.videoWidth, video.videoHeight)\n\n        if (video.videoWidth > video.videoHeight) {\n          arContext.arToolkitContext.arController.orientation = \"landscape\"\n          arContext.arToolkitContext.arController.options.orientation = \"landscape\"\n        } else {\n          arContext.arToolkitContext.arController.orientation = \"portrait\"\n          arContext.arToolkitContext.arController.options.orientation = \"portrait\"\n        }\n\n        if (onCameraStreamReady) {\n          onCameraStreamReady()\n        }\n        onResize()\n      }\n    }, onCameraStreamError)\n\n    arContext.arToolkitContext.init(() =>\n      camera.projectionMatrix.copy(arContext.arToolkitContext.getProjectionMatrix()),\n    )\n\n    window.addEventListener(\"resize\", onResize)\n\n    return onUnmount\n  }, [arContext, camera, onCameraStreamReady, onCameraStreamError, onResize, onUnmount])\n\n  useFrame(() => {\n    if (!tracking) {\n      return\n    }\n\n    if (arContext.arToolkitSource && arContext.arToolkitSource.ready !== false) {\n      arContext.arToolkitContext.update(arContext.arToolkitSource.domElement)\n    }\n  })\n\n  const value = useMemo(() => ({ arToolkitContext: arContext.arToolkitContext }), [arContext])\n\n  return <ARContext.Provider value={value}>{children}</ARContext.Provider>\n})\n\nconst useAR = () => {\n  const arValue = React.useContext(ARContext)\n  return React.useMemo(() => ({ ...arValue }), [arValue])\n}\n\nexport { AR, useAR }\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AACA;;;;;;;;;;;;AAEA,IAAMA,SAAS,gBAAG,IAAAC,oBAAA,EAAc,EAAd,CAAlB;AACA,IAAMC,oBAAoB,GAAG,aAA7B;;AAEA,IAAMC,EAAE,gBAAGC,iBAAA,CAAMC,IAAN,CAAW,SAASF,EAAT,OAUnB;EAAA,yBATDG,QASC;EAAA,IATDA,QASC,8BATU,IASV;EAAA,IARDC,QAQC,QARDA,QAQC;EAAA,IAPDC,UAOC,QAPDA,UAOC;EAAA,IANDC,YAMC,QANDA,YAMC;EAAA,IALDC,cAKC,QALDA,cAKC;EAAA,IAJDC,aAIC,QAJDA,aAIC;EAAA,IAHDC,mBAGC,QAHDA,mBAGC;EAAA,IAFDC,mBAEC,QAFDA,mBAEC;EAAA,IADDC,mBACC,QADDA,mBACC;;EACD,gBAAuB,IAAAC,eAAA,GAAvB;EAAA,IAAQC,EAAR,aAAQA,EAAR;EAAA,IAAYC,MAAZ,aAAYA,MAAZ;;EAEA,IAAMC,SAAS,GAAG,IAAAC,cAAA,EAAQ,YAAM;IAC9B,IAAMC,eAAe,GAAG,IAAIC,yBAAJ,CAAoB;MAAEb,UAAU,EAAVA;IAAF,CAApB,CAAxB;IACA,IAAMc,gBAAgB,GAAG,IAAIC,0BAAJ,CAAqB;MAC5CX,mBAAmB,EAAnBA,mBAD4C;MAE5CD,aAAa,EAAbA,aAF4C;MAG5CF,YAAY,EAAZA,YAH4C;MAI5CC,cAAc,EAAdA;IAJ4C,CAArB,CAAzB;IAOA,OAAO;MAAEY,gBAAgB,EAAhBA,gBAAF;MAAoBF,eAAe,EAAfA;IAApB,CAAP;EACD,CAViB,EAUf,CAACX,YAAD,EAAeC,cAAf,EAA+BE,mBAA/B,EAAoDD,aAApD,EAAmEH,UAAnE,CAVe,CAAlB;EAYA,IAAMgB,QAAQ,GAAG,IAAAC,kBAAA,EAAY,YAAM;IACjC,IAAQH,gBAAR,GAA8CJ,SAA9C,CAAQI,gBAAR;IAAA,IAA0BF,eAA1B,GAA8CF,SAA9C,CAA0BE,eAA1B;IAEAA,eAAe,CAACM,eAAhB;IACAN,eAAe,CAACO,iBAAhB,CAAkCX,EAAE,CAACY,UAArC;;IACA,IAAIN,gBAAgB,CAACO,YAAjB,KAAkC,IAAtC,EAA4C;MAC1CT,eAAe,CAACO,iBAAhB,CAAkCL,gBAAgB,CAACO,YAAjB,CAA8BC,MAAhE;MACAb,MAAM,CAACc,gBAAP,CAAwBC,IAAxB,CAA6BV,gBAAgB,CAACW,mBAAjB,EAA7B;IACD;EACF,CATgB,EASd,CAACjB,EAAD,EAAKE,SAAL,EAAgBD,MAAhB,CATc,CAAjB;EAWA,IAAMiB,SAAS,GAAG,IAAAT,kBAAA,EAAY,YAAM;IAClCU,MAAM,CAACC,mBAAP,CAA2B,QAA3B,EAAqCZ,QAArC;IAEAN,SAAS,CAACI,gBAAV,CAA2BO,YAA3B,CAAwCQ,OAAxC;;IACA,IAAInB,SAAS,CAACI,gBAAV,CAA2BO,YAA3B,CAAwCS,WAA5C,EAAyD;MACvDpB,SAAS,CAACI,gBAAV,CAA2BO,YAA3B,CAAwCS,WAAxC,CAAoDD,OAApD;IACD;;IAED,OAAOnB,SAAS,CAACI,gBAAjB;IACA,OAAOJ,SAAS,CAACE,eAAjB;IAEA,IAAMmB,KAAK,GAAGC,QAAQ,CAACC,aAAT,CAAuBvC,oBAAvB,CAAd;;IACA,IAAIqC,KAAJ,EAAW;MACTA,KAAK,CAACG,SAAN,CAAgBC,SAAhB,GAA4BC,GAA5B,CAAgC,UAAAC,KAAK;QAAA,OAAIA,KAAK,CAACC,IAAN,EAAJ;MAAA,CAArC;MACAP,KAAK,CAACQ,MAAN;IACD;EACF,CAhBiB,EAgBf,CAACvB,QAAD,EAAWN,SAAX,CAhBe,CAAlB;EAkBA,IAAA8B,gBAAA,EAAU,YAAM;IACd9B,SAAS,CAACE,eAAV,CAA0B6B,IAA1B,CAA+B,YAAM;MACnC,IAAMV,KAAK,GAAGC,QAAQ,CAACC,aAAT,CAAuBvC,oBAAvB,CAAd;MACAqC,KAAK,CAACW,KAAN,CAAYC,QAAZ,GAAuB,OAAvB;MACAZ,KAAK,CAACW,KAAN,CAAYE,aAAZ,GAA4B,MAA5B;;MAEAb,KAAK,CAACc,gBAAN,GAAyB,YAAM;QAC7BC,OAAO,CAACC,GAAR,CAAY,0BAAZ,EAAwChB,KAAK,CAACiB,UAA9C,EAA0DjB,KAAK,CAACkB,WAAhE;;QAEA,IAAIlB,KAAK,CAACiB,UAAN,GAAmBjB,KAAK,CAACkB,WAA7B,EAA0C;UACxCvC,SAAS,CAACI,gBAAV,CAA2BO,YAA3B,CAAwC6B,WAAxC,GAAsD,WAAtD;UACAxC,SAAS,CAACI,gBAAV,CAA2BO,YAA3B,CAAwC8B,OAAxC,CAAgDD,WAAhD,GAA8D,WAA9D;QACD,CAHD,MAGO;UACLxC,SAAS,CAACI,gBAAV,CAA2BO,YAA3B,CAAwC6B,WAAxC,GAAsD,UAAtD;UACAxC,SAAS,CAACI,gBAAV,CAA2BO,YAA3B,CAAwC8B,OAAxC,CAAgDD,WAAhD,GAA8D,UAA9D;QACD;;QAED,IAAI7C,mBAAJ,EAAyB;UACvBA,mBAAmB;QACpB;;QACDW,QAAQ;MACT,CAfD;IAgBD,CArBD,EAqBGV,mBArBH;IAuBAI,SAAS,CAACI,gBAAV,CAA2B2B,IAA3B,CAAgC;MAAA,OAC9BhC,MAAM,CAACc,gBAAP,CAAwBC,IAAxB,CAA6Bd,SAAS,CAACI,gBAAV,CAA2BW,mBAA3B,EAA7B,CAD8B;IAAA,CAAhC;IAIAE,MAAM,CAACyB,gBAAP,CAAwB,QAAxB,EAAkCpC,QAAlC;IAEA,OAAOU,SAAP;EACD,CA/BD,EA+BG,CAAChB,SAAD,EAAYD,MAAZ,EAAoBJ,mBAApB,EAAyCC,mBAAzC,EAA8DU,QAA9D,EAAwEU,SAAxE,CA/BH;EAiCA,IAAA2B,eAAA,EAAS,YAAM;IACb,IAAI,CAACvD,QAAL,EAAe;MACb;IACD;;IAED,IAAIY,SAAS,CAACE,eAAV,IAA6BF,SAAS,CAACE,eAAV,CAA0B0C,KAA1B,KAAoC,KAArE,EAA4E;MAC1E5C,SAAS,CAACI,gBAAV,CAA2ByC,MAA3B,CAAkC7C,SAAS,CAACE,eAAV,CAA0BQ,UAA5D;IACD;EACF,CARD;EAUA,IAAMoC,KAAK,GAAG,IAAA7C,cAAA,EAAQ;IAAA,OAAO;MAAEG,gBAAgB,EAAEJ,SAAS,CAACI;IAA9B,CAAP;EAAA,CAAR,EAAkE,CAACJ,SAAD,CAAlE,CAAd;EAEA,oBAAO,gCAAC,SAAD,CAAW,QAAX;IAAoB,KAAK,EAAE8C;EAA3B,GAAmCzD,QAAnC,CAAP;AACD,CApGU,CAAX;;;;AAsGA,IAAM0D,KAAK,GAAG,SAARA,KAAQ,GAAM;EAClB,IAAMC,OAAO,GAAG9D,iBAAA,CAAM+D,UAAN,CAAiBnE,SAAjB,CAAhB;;EACA,OAAOI,iBAAA,CAAMe,OAAN,CAAc;IAAA,yBAAY+C,OAAZ;EAAA,CAAd,EAAsC,CAACA,OAAD,CAAtC,CAAP;AACD,CAHD"}